<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RadIMO Cortex | Skill Matrix</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f0f0f0;
      padding: 1rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: #fff;
      padding: 1rem 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      margin: 0;
      font-size: 1.75rem;
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.2s;
    }

    .btn-primary {
      background: #004892;
      color: white;
    }

    .btn-primary:hover {
      background: #003670;
    }

    .btn-secondary {
      background: #777;
      color: white;
    }

    .btn-secondary:hover {
      background: #555;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .content-box {
      background: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .legend {
      margin-bottom: 1rem;
      padding: 1rem;
      background: #e7f3ff;
      border-left: 4px solid #004892;
      border-radius: 4px;
    }

    .legend-item {
      display: inline-block;
      margin-right: 1.5rem;
    }

    .legend-item code {
      background: #fff;
      padding: 0.2rem 0.5rem;
      border-radius: 3px;
      font-weight: bold;
    }

    .roster-table-container {
      overflow-x: auto;
      margin-top: 1rem;
    }

    .roster-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .roster-table th,
    .roster-table td {
      padding: 0.5rem;
      text-align: center;
      border: 1px solid #ddd;
    }

    .roster-table th {
      background: #f8f9fa;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .roster-table th.worker-col {
      text-align: left;
      background: #004892;
      color: white;
    }

    .roster-table td.worker-id {
      text-align: left;
      font-weight: 600;
      background: #f8f9fa;
    }

    .skill-input {
      width: 50px;
      padding: 0.3rem;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 0.9rem;
    }

    .skill-input:focus {
      outline: none;
      border-color: #004892;
      box-shadow: 0 0 3px rgba(0, 72, 146, 0.3);
    }

    .skill-input.value--1 {
      background: #ffe6e6;
    }

    .skill-input.value-0 {
      background: #fff8e6;
    }

    .skill-input.value-1 {
      background: #e6ffe6;
    }

    .add-worker-section {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 2px solid #e0e0e0;
    }

    .add-worker-form {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .add-worker-form input {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95rem;
    }

    .status-message {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 4px;
      display: none;
    }

    .status-message.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .status-message.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #777;
    }

    .modality-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #004892;
    }

    .modality-section h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: #004892;
      font-size: 1.2rem;
    }

    .modality-section .hint {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 1rem;
    }

    .override-input {
      width: 50px;
      padding: 0.3rem;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 0.9rem;
      background: #fff;
    }

    .override-input:focus {
      outline: none;
      border-color: #004892;
      box-shadow: 0 0 3px rgba(0, 72, 146, 0.3);
    }

    .override-input.has-override {
      border: 2px solid #ff9800;
      font-weight: bold;
    }

    .override-input.value--1 {
      background: #ffe6e6;
    }

    .override-input.value-0 {
      background: #fff8e6;
    }

    .override-input.value-1 {
      background: #e6ffe6;
    }

    .clear-override-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.75rem;
      margin-left: 0.25rem;
    }

    .clear-override-btn:hover {
      background: #5a6268;
    }

    .remove-worker-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .remove-worker-btn:hover {
      background: #c82333;
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>RadIMO Cortex | Skill Matrix <span style="color: #ff9800; font-size: 1rem;">(Planning Mode)</span></h1>
      <p>Worker skill configuration and management</p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('index') }}">Dashboard</a>
      <a href="{{ url_for('timetable') }}">Timetable</a>
      <a href="{{ url_for('live_edit_page') }}">Day Control</a>
      <a href="{{ url_for('upload_file') }}">Admin</a>
      <a href="{{ url_for('prep_next_day') }}">Prep Next Day</a>
      <button class="btn btn-secondary" onclick="reloadRoster()">Reload Staged</button>
      <button class="btn btn-primary" onclick="saveRoster()">Save to Staging</button>
      <button class="btn btn-success" onclick="activateRoster()">Activate Changes</button>
    </div>
  </div>

  <div class="content-box">
    <div class="legend">
      <strong>⚠️ Planning Mode:</strong> Changes here are STAGED only and do NOT affect current assignments until you click "Activate Changes".
      <br><br>
      <strong>Legend:</strong>
      <div class="legend-item"><code>-1</code> = Excluded (never use)</div>
      <div class="legend-item"><code>0</code> = Passive (fallback only)</div>
      <div class="legend-item"><code>1</code> = Active (primary + fallback)</div>
    </div>

    <div id="loading" class="loading">Loading roster...</div>

    <div id="rosterContainer" style="display: none;">
      <h3>Default Skills (applies to all modalities unless overridden below)</h3>
      <div class="roster-table-container">
        <table class="roster-table" id="defaultTable">
          <thead>
            <tr>
              <th class="worker-col">Worker ID</th>
              <!-- Skills will be added dynamically -->
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="defaultTableBody">
            <!-- Rows will be added dynamically -->
          </tbody>
        </table>
      </div>

      <div id="modalityTablesContainer">
        <!-- Per-modality override tables will be added dynamically -->
      </div>

      <div class="add-worker-section">
        <h4>Add New Worker</h4>
        <div class="add-worker-form">
          <input type="text" id="newWorkerId" placeholder="Worker ID (e.g., AAn, AN)" />
          <button class="btn btn-primary" onclick="addWorker()">Add Worker</button>
        </div>
      </div>
    </div>

    <div id="statusMessage" class="status-message"></div>
  </div>

  <script>
    let rosterData = {};
    let skills = [];
    let modalities = [];

    // Load roster on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadRoster();
    });

    async function loadRoster() {
      try {
        const response = await fetch('/api/admin/skill_roster');
        const data = await response.json();

        if (data.success) {
          rosterData = data.roster;
          skills = data.skills;
          modalities = data.modalities;

          renderRosterTable();

          document.getElementById('loading').style.display = 'none';
          document.getElementById('rosterContainer').style.display = 'block';
        } else {
          showStatus('Failed to load roster: ' + data.error, 'error');
        }
      } catch (error) {
        showStatus('Error loading roster: ' + error.message, 'error');
      }
    }

    function renderRosterTable() {
      const table = document.getElementById('defaultTable');
      const thead = table.querySelector('thead tr');
      const tbody = document.getElementById('defaultTableBody');

      // Clear existing content
      thead.innerHTML = '<th class="worker-col">Worker ID</th>';
      tbody.innerHTML = '';

      // Add skill column headers
      skills.forEach(skill => {
        const th = document.createElement('th');
        th.textContent = skill;
        thead.appendChild(th);
      });

      // Add actions column
      const thActions = document.createElement('th');
      thActions.textContent = 'Actions';
      thead.appendChild(thActions);

      // Add worker rows
      const workerIds = Object.keys(rosterData).sort();

      workerIds.forEach(workerId => {
        const row = document.createElement('tr');

        // Worker ID cell
        const cellId = document.createElement('td');
        cellId.className = 'worker-id';
        cellId.textContent = workerId;
        row.appendChild(cellId);

        // Skill cells
        const defaultSkills = rosterData[workerId].default || {};

        skills.forEach(skill => {
          const cell = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'number';
          input.className = 'skill-input';
          input.min = '-1';
          input.max = '1';
          input.step = '1';
          input.value = defaultSkills[skill] !== undefined ? defaultSkills[skill] : 0;
          input.dataset.workerId = workerId;
          input.dataset.skill = skill;

          // Add color class based on value
          updateInputColor(input);

          input.addEventListener('change', function() {
            updateSkillValue(workerId, skill, parseInt(this.value));
            updateInputColor(this);
          });

          cell.appendChild(input);
          row.appendChild(cell);
        });

        // Actions cell
        const cellActions = document.createElement('td');
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-worker-btn';
        removeBtn.textContent = 'Remove';
        removeBtn.onclick = () => removeWorker(workerId);
        cellActions.appendChild(removeBtn);
        row.appendChild(cellActions);

        tbody.appendChild(row);
      });

      // Render per-modality override tables
      renderModalityTables();
    }

    function renderModalityTables() {
      const container = document.getElementById('modalityTablesContainer');
      container.innerHTML = '';

      const workerIds = Object.keys(rosterData).sort();

      modalities.forEach(modality => {
        const section = document.createElement('div');
        section.className = 'modality-section';

        const title = document.createElement('h3');
        title.textContent = `${modality.toUpperCase()} Overrides`;
        section.appendChild(title);

        const hint = document.createElement('p');
        hint.className = 'hint';
        hint.textContent = 'Leave empty to use default. Set value to override for this modality only. Orange border = override active.';
        section.appendChild(hint);

        const tableContainer = document.createElement('div');
        tableContainer.className = 'roster-table-container';

        const table = document.createElement('table');
        table.className = 'roster-table';

        // Header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');

        const thWorker = document.createElement('th');
        thWorker.className = 'worker-col';
        thWorker.textContent = 'Worker ID';
        headerRow.appendChild(thWorker);

        skills.forEach(skill => {
          const th = document.createElement('th');
          th.textContent = skill;
          headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Body
        const tbody = document.createElement('tbody');

        workerIds.forEach(workerId => {
          const row = document.createElement('tr');

          // Worker ID cell
          const cellId = document.createElement('td');
          cellId.className = 'worker-id';
          cellId.textContent = workerId;
          row.appendChild(cellId);

          // Skill cells - show override or empty
          const modalityOverrides = rosterData[workerId][modality] || {};

          skills.forEach(skill => {
            const cell = document.createElement('td');

            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'override-input';
            input.min = '-1';
            input.max = '1';
            input.step = '1';
            input.placeholder = '—';
            input.dataset.workerId = workerId;
            input.dataset.modality = modality;
            input.dataset.skill = skill;

            // Set value if override exists
            if (modalityOverrides[skill] !== undefined) {
              input.value = modalityOverrides[skill];
              input.classList.add('has-override');
              updateOverrideInputColor(input);
            }

            input.addEventListener('change', function() {
              updateModalitySkillValue(workerId, modality, skill, this.value);
              if (this.value !== '') {
                this.classList.add('has-override');
                updateOverrideInputColor(this);
              } else {
                this.classList.remove('has-override', 'value--1', 'value-0', 'value-1');
              }
            });

            cell.appendChild(input);

            // Add clear button if has override
            if (modalityOverrides[skill] !== undefined) {
              const clearBtn = document.createElement('button');
              clearBtn.className = 'clear-override-btn';
              clearBtn.textContent = '×';
              clearBtn.title = 'Clear override';
              clearBtn.onclick = () => {
                clearModalityOverride(workerId, modality, skill);
                renderModalityTables();
              };
              cell.appendChild(clearBtn);
            }

            row.appendChild(cell);
          });

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        tableContainer.appendChild(table);
        section.appendChild(tableContainer);
        container.appendChild(section);
      });
    }

    function updateOverrideInputColor(input) {
      input.classList.remove('value--1', 'value-0', 'value-1');
      const val = parseInt(input.value);
      if (val === -1) input.classList.add('value--1');
      else if (val === 0) input.classList.add('value-0');
      else if (val === 1) input.classList.add('value-1');
    }

    function updateModalitySkillValue(workerId, modality, skill, value) {
      // Ensure worker exists
      if (!rosterData[workerId]) {
        rosterData[workerId] = { default: {} };
      }

      // If value is empty, remove the override
      if (value === '' || value === null) {
        if (rosterData[workerId][modality]) {
          delete rosterData[workerId][modality][skill];
          // Clean up empty modality object
          if (Object.keys(rosterData[workerId][modality]).length === 0) {
            delete rosterData[workerId][modality];
          }
        }
        return;
      }

      // Ensure modality object exists
      if (!rosterData[workerId][modality]) {
        rosterData[workerId][modality] = {};
      }

      // Set the override value
      rosterData[workerId][modality][skill] = parseInt(value);
    }

    function clearModalityOverride(workerId, modality, skill) {
      if (rosterData[workerId] && rosterData[workerId][modality]) {
        delete rosterData[workerId][modality][skill];
        // Clean up empty modality object
        if (Object.keys(rosterData[workerId][modality]).length === 0) {
          delete rosterData[workerId][modality];
        }
      }
    }

    function updateInputColor(input) {
      input.classList.remove('value--1', 'value-0', 'value-1');
      const val = parseInt(input.value);
      if (val === -1) input.classList.add('value--1');
      else if (val === 0) input.classList.add('value-0');
      else if (val === 1) input.classList.add('value-1');
    }

    function updateSkillValue(workerId, skill, value) {
      // Ensure worker exists in roster
      if (!rosterData[workerId]) {
        rosterData[workerId] = { default: {} };
      }
      if (!rosterData[workerId].default) {
        rosterData[workerId].default = {};
      }

      // Update value
      rosterData[workerId].default[skill] = value;
    }

    function addWorker() {
      const workerId = document.getElementById('newWorkerId').value.trim();

      if (!workerId) {
        showStatus('Please enter a worker ID', 'error');
        return;
      }

      if (rosterData[workerId]) {
        showStatus('Worker already exists', 'error');
        return;
      }

      // Add worker with default skills
      rosterData[workerId] = {
        default: {}
      };

      // Initialize all skills to 0
      skills.forEach(skill => {
        rosterData[workerId].default[skill] = 0;
      });

      // Re-render table
      renderRosterTable();

      // Clear input
      document.getElementById('newWorkerId').value = '';

      showStatus('Worker added successfully. Remember to save to staging and activate!', 'success');
    }

    function removeWorker(workerId) {
      if (!confirm(`Remove worker "${workerId}"?`)) {
        return;
      }

      delete rosterData[workerId];
      renderRosterTable();

      showStatus('Worker removed from staging. Remember to save and activate!', 'success');
    }

    async function saveRoster() {
      try {
        const response = await fetch('/api/admin/skill_roster', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ roster: rosterData })
        });

        const data = await response.json();

        if (data.success) {
          showStatus(data.message, 'success');
        } else {
          showStatus('Failed to save: ' + data.error, 'error');
        }
      } catch (error) {
        showStatus('Error saving roster: ' + error.message, 'error');
      }
    }

    async function reloadRoster() {
      if (!confirm('Reload staged roster from JSON file? Unsaved changes will be lost.')) {
        return;
      }

      try {
        const response = await fetch('/api/admin/skill_roster/reload', {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          showStatus(data.message, 'success');
          // Reload the page to show updated data
          setTimeout(() => location.reload(), 1000);
        } else {
          showStatus('Failed to reload: ' + data.error, 'error');
        }
      } catch (error) {
        showStatus('Error reloading roster: ' + error.message, 'error');
      }
    }

    async function activateRoster() {
      if (!confirm('⚠️ ACTIVATE staged changes?\n\nThis will make your staged roster changes IMMEDIATELY ACTIVE for all assignments.\n\nContinue?')) {
        return;
      }

      try {
        const response = await fetch('/api/admin/skill_roster/activate', {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          showStatus(data.message + ' - Changes are NOW ACTIVE!', 'success');
        } else {
          showStatus('Failed to activate: ' + data.error, 'error');
        }
      } catch (error) {
        showStatus('Error activating roster: ' + error.message, 'error');
      }
    }

    function showStatus(message, type) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = 'status-message ' + type;
      statusEl.style.display = 'block';

      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 5000);
    }
  </script>
</body>
</html>
